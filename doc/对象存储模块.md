# å¯¹è±¡å­˜å‚¨æ¨¡å—

## æ¨¡å—è¯´æ˜

è¿™æ˜¯ä¸€ä¸ªçµæ´»çš„å¯¹è±¡å­˜å‚¨æŠ½è±¡å±‚ï¼Œæ”¯æŒå¤šç§å­˜å‚¨æœåŠ¡çš„æ— ç¼åˆ‡æ¢ã€‚é€šè¿‡ç»Ÿä¸€çš„`StorageService`æ¥å£ï¼Œå¯ä»¥æ–¹ä¾¿åœ°åœ¨ä¸åŒçš„å­˜å‚¨åç«¯ä¹‹é—´åˆ‡æ¢ï¼Œè€Œæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç ã€‚

## æ¶æ„è®¾è®¡

```
storage/
â”œâ”€â”€ StorageService.java              # ç»Ÿä¸€å­˜å‚¨æœåŠ¡æ¥å£
â”œâ”€â”€ config/
â”‚   â””â”€â”€ StorageConfig.java          # å­˜å‚¨é…ç½®ç±»ï¼ˆåŠ¨æ€é€‰æ‹©å®ç°ï¼‰
â”œâ”€â”€ enums/
â”‚   â””â”€â”€ StorageType.java            # å­˜å‚¨ç±»å‹æšä¸¾
â”œâ”€â”€ properties/
â”‚   â”œâ”€â”€ StorageProperties.java      # é€šç”¨å­˜å‚¨é…ç½®
â”‚   â”œâ”€â”€ OSSProperties.java          # é˜¿é‡Œäº‘OSSé…ç½®
â”‚   â””â”€â”€ ...                         # å…¶ä»–å­˜å‚¨æœåŠ¡é…ç½®
â””â”€â”€ impl/
    â”œâ”€â”€ MinioStorageServiceImpl.java    # MinIOå®ç°
    â”œâ”€â”€ OSSStorageServiceImpl.java      # é˜¿é‡Œäº‘OSSå®ç°
    â””â”€â”€ ...                             # å…¶ä»–å­˜å‚¨æœåŠ¡å®ç°
```

## å¿«é€Ÿå¼€å§‹

### 1. ä½¿ç”¨MinIOï¼ˆé»˜è®¤ï¼‰

**é…ç½®æ–‡ä»¶ (application.yml)**

```yaml
# å­˜å‚¨é…ç½®
storage:
  type: minio          # å­˜å‚¨ç±»å‹
  enabled: true        # æ˜¯å¦å¯ç”¨
  default-bucket: cropseed-trace

# MinIOé…ç½®
minio:
  endpoint: http://localhost:9000
  access-key: minioadmin
  secret-key: minioadmin
  bucket-name: cropseed-trace
```

### 2. ä½¿ç”¨é˜¿é‡Œäº‘OSS

**é…ç½®æ–‡ä»¶ (application.yml)**

```yaml
# å­˜å‚¨é…ç½®
storage:
  type: oss            # åˆ‡æ¢åˆ°é˜¿é‡Œäº‘OSS
  enabled: true
  default-bucket: your-bucket

# é˜¿é‡Œäº‘OSSé…ç½®
storage:
  oss:
    endpoint: oss-cn-beijing.aliyuncs.com
    access-key-id: your-access-key-id
    access-key-secret: your-access-key-secret
    bucket-name: your-bucket
```

**æ·»åŠ ä¾èµ– (pom.xml)**

```xml
<!-- é˜¿é‡Œäº‘OSS SDK -->
<dependency>
    <groupId>com.aliyun.oss</groupId>
    <artifactId>aliyun-sdk-oss</artifactId>
    <version>3.17.1</version>
</dependency>
```

### 3.æœ¬åœ°å­˜å‚¨

```yaml
# å­˜å‚¨é€šç”¨é…ç½®
storage:
  type: local Â  Â  Â  Â  Â  Â  Â # ä½¿ç”¨æœ¬åœ°å­˜å‚¨
  enabled: true
# æœ¬åœ°å­˜å‚¨é…ç½®
local:
  base-path: ./data/storage Â  Â  Â  Â  Â  Â  Â  Â  Â # å­˜å‚¨æ ¹ç›®å½•
  url-prefix: http://localhost:8085 Â  Â  Â  Â  Â # HTTPè®¿é—®å‰ç¼€
  bucket-name: cropseed-trace Â  Â  Â  Â  Â  Â  Â  Â # é»˜è®¤bucket
  auto-create-directory: true Â  Â  Â  Â  Â  Â  Â  Â # è‡ªåŠ¨åˆ›å»ºç›®å½•
```

ç›®å½•ç»“æ„

```
data/
â””â”€â”€ storage/                    # æ ¹ç›®å½•ï¼ˆbase-pathï¼‰
    â””â”€â”€ cropseed-trace/         # bucketåç§°
        â”œâ”€â”€ images/             # è‡ªå®šä¹‰æ–‡ä»¶å¤¹
        â”‚   â”œâ”€â”€ abc123.jpg
        â”‚   â””â”€â”€ def456.png
        â”œâ”€â”€ documents/
        â”‚   â””â”€â”€ report.pdf
        â””â”€â”€ exports/
            â””â”€â”€ data.xlsx
```



## ğŸ¯ æ‰©å±•æ–°çš„å­˜å‚¨æœåŠ¡

### æ­¥éª¤1ï¼šåˆ›å»ºé…ç½®ç±»

```java
@Data
@Configuration
@ConfigurationProperties(prefix = "storage.your-storage")
@ConditionalOnProperty(name = "storage.type", havingValue = "your-storage")
public class YourStorageProperties {
    private String endpoint;
    private String accessKey;
    private String secretKey;
    private String bucketName;
    
    @Bean
    @ConditionalOnProperty(name = "storage.type", havingValue = "your-storage")
    public YourStorageClient yourStorageClient() {
        return new YourStorageClient(endpoint, accessKey, secretKey);
    }
}
```

### æ­¥éª¤2ï¼šå®ç°StorageServiceæ¥å£

```java
@Slf4j
@Service("yourStorageService")
@RequiredArgsConstructor
@ConditionalOnProperty(name = "storage.type", havingValue = "your-storage")
public class YourStorageServiceImpl implements StorageService {
    
    private final YourStorageClient client;
    private final YourStorageProperties config;
    
    @Override
    public String uploadFile(MultipartFile file, String folder) {
        // å®ç°ä¸Šä¼ é€»è¾‘
    }
    
    // å®ç°å…¶ä»–æ¥å£æ–¹æ³•...
}
```

### æ­¥éª¤3ï¼šæ·»åŠ é…ç½®

```yaml
storage:
  type: your-storage
  enabled: true
  
your-storage:
  endpoint: your-endpoint
  access-key: your-key
  secret-key: your-secret
  bucket-name: your-bucket
```

## é…ç½®ä¼˜å…ˆçº§

1. `storage.type` - æŒ‡å®šä½¿ç”¨çš„å­˜å‚¨ç±»å‹
2. `@ConditionalOnProperty` - æ ¹æ®é…ç½®æ¡ä»¶åŠ è½½
3. `StorageConfig.storageService()` - åŠ¨æ€é€‰æ‹©Bean
4. é™çº§æœºåˆ¶ - å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°MinIO
