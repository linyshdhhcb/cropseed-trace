# ğŸŒ¾ å†œä½œç‰©ç§è´¨èµ„æºæ•°å­—åŒ–æº¯æºç³»ç»Ÿ - æº¯æºæ¨¡å—å®ç°è¯´æ˜

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

åŸºäºè…¾è®¯äº‘TBaasæœåŠ¡ï¼Œå®ç°äº†å®Œæ•´çš„å†œä½œç‰©ç§è´¨èµ„æºæº¯æºåŠŸèƒ½ï¼ŒåŒ…å«åŒºå—é“¾ä¸Šé“¾ã€æ•°æ®éªŒè¯ã€æº¯æºæŸ¥è¯¢ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- âœ… **åŒºå—é“¾å­˜è¯**ï¼šé›†æˆè…¾è®¯äº‘TBaasé•¿å®‰é“¾ä½“éªŒç½‘ç»œï¼Œå®ç°æº¯æºæ•°æ®ä¸Šé“¾
- âœ… **æ™ºèƒ½æº¯æºç **ï¼šåŸºäºåœ°åŒº+å¹´ä»½+åºå·çš„å”¯ä¸€æº¯æºç ç”Ÿæˆæœºåˆ¶
- âœ… **å®Œæ•´æº¯æºé“¾**ï¼šæ”¯æŒç”Ÿäº§ã€è´¨æ£€ã€æµé€šã€é”€å”®ç­‰å…¨ç¯èŠ‚è®°å½•
- âœ… **æ•°æ®å®Œæ•´æ€§éªŒè¯**ï¼šæœ¬åœ°æ•°æ®ä¸åŒºå—é“¾æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ
- âœ… **åˆ†å¸ƒå¼é”ä¿æŠ¤**ï¼šé˜²æ­¢å¹¶å‘å†²çªå’Œæ•°æ®ä¸ä¸€è‡´
- âœ… **å¼‚æ­¥ä¸Šé“¾å¤„ç†**ï¼šä¿è¯ä¸šåŠ¡æ€§èƒ½ï¼Œå¼‚æ­¥å¤„ç†åŒºå—é“¾äº¤äº’
- âœ… **å®Œæ•´æµ‹è¯•è¦†ç›–**ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ§åˆ¶å™¨æµ‹è¯•å…¨è¦†ç›–

## ğŸ— ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯åº”ç”¨      â”‚    â”‚   åç«¯æœåŠ¡      â”‚    â”‚  è…¾è®¯äº‘TBaas    â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æº¯æºæŸ¥è¯¢    â”‚ â”‚â—„â”€â”€â–ºâ”‚ â”‚ Controller  â”‚ â”‚    â”‚ â”‚ é•¿å®‰é“¾ç½‘ç»œ  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ è®°å½•ç®¡ç†    â”‚ â”‚â—„â”€â”€â–ºâ”‚ â”‚ Service     â”‚ â”‚â—„â”€â”€â–ºâ”‚ â”‚ æ™ºèƒ½åˆçº¦    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æº¯æºç ç”Ÿæˆ  â”‚ â”‚â—„â”€â”€â–ºâ”‚ â”‚ Blockchain  â”‚ â”‚    â”‚ â”‚ å­˜è¯æœåŠ¡    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   MySQLæ•°æ®åº“   â”‚
                    â”‚                 â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚ æº¯æºè®°å½•è¡¨  â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚ æº¯æºå®ä½“è¡¨  â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚ æŸ¥è¯¢è®°å½•è¡¨  â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

1. **trace_record** - æº¯æºè®°å½•è¡¨
   - å­˜å‚¨å®Œæ•´çš„æº¯æºè®°å½•ä¿¡æ¯
   - æ”¯æŒåŒºå—é“¾çŠ¶æ€è·Ÿè¸ª
   - åŒ…å«æ¸©åº¦ã€æ¹¿åº¦ã€è´¨é‡ç­‰è¯¦ç»†æ•°æ®

2. **trace_entity** - æº¯æºå®ä½“è¡¨
   - ç®¡ç†ç”Ÿäº§åŸºåœ°ã€åŠ å·¥å‚ã€ä»“åº“ç­‰å®ä½“
   - æ”¯æŒåœ°ç†ä½ç½®å’Œè®¤è¯ä¿¡æ¯

3. **trace_code_config** - æº¯æºç é…ç½®è¡¨
   - ç®¡ç†ä¸åŒåœ°åŒºçš„æº¯æºç ç”Ÿæˆè§„åˆ™
   - æ”¯æŒåºå·è‡ªå¢å’Œæ ¼å¼å®šåˆ¶

4. **trace_query** - æŸ¥è¯¢è®°å½•è¡¨
   - è®°å½•æ¶ˆè´¹è€…æŸ¥è¯¢è¡Œä¸º
   - æ”¯æŒæŸ¥è¯¢ç»Ÿè®¡å’Œç”¨æˆ·åé¦ˆ

## ğŸ”§ æŠ€æœ¯å®ç°

### æº¯æºç ç”Ÿæˆç®—æ³•

```java
// æ ¼å¼ï¼šåœ°åŒºä»£ç (2ä½) + å¹´ä»½(4ä½) + åºå·(6ä½)
// ç¤ºä¾‹ï¼šBJ2024000001
String traceCode = String.format("%s%d%06d", 
    regionPrefix, currentYear, sequenceNumber);
```

### åŒºå—é“¾é›†æˆ

```yaml
# TBaasé…ç½®
tencent:
  tbaas:
    cluster-id: chainmaker-demo
    chain-id: chain_demo
    contract-name: ChainMakerDemo
    region: ap-beijing
```

### æ•°æ®ä¸Šé“¾æµç¨‹

```java
1. æœ¬åœ°æ•°æ®åº“å­˜å‚¨ (ç¡®ä¿ä¸šåŠ¡æ•°æ®å®‰å…¨)
2. å¼‚æ­¥åŒºå—é“¾ä¸Šé“¾ (é¿å…å½±å“ä¸šåŠ¡æ€§èƒ½)
3. ä¸Šé“¾çŠ¶æ€è·Ÿè¸ª (0-æœªä¸Šé“¾, 1-ä¸Šé“¾ä¸­, 2-æˆåŠŸ, 3-å¤±è´¥)
4. æ•°æ®å®Œæ•´æ€§éªŒè¯ (æœ¬åœ°å“ˆå¸Œ vs é“¾ä¸Šå“ˆå¸Œ)
```

## ğŸš€ APIæ¥å£

### æº¯æºè®°å½•ç®¡ç†

```http
POST   /api/trace/records              # åˆ›å»ºæº¯æºè®°å½•
GET    /api/trace/records/chain/{code}  # è·å–å®Œæ•´æº¯æºé“¾
GET    /api/trace/records/page          # åˆ†é¡µæŸ¥è¯¢è®°å½•
POST   /api/trace/records/verify/{code} # éªŒè¯æ•°æ®å®Œæ•´æ€§
GET    /api/trace/records/proof/{code}  # è·å–åŒºå—é“¾è¯æ˜
POST   /api/trace/records/batch-upload  # æ‰¹é‡ä¸Šé“¾
```

### æº¯æºç ç®¡ç†

```http
POST   /api/trace/codes/generate        # ç”Ÿæˆæº¯æºç 
POST   /api/trace/codes/validate        # éªŒè¯æº¯æºç 
GET    /api/trace/codes/parse/{code}    # è§£ææº¯æºç 
GET    /api/trace/codes/regions         # è·å–åœ°åŒºåˆ—è¡¨
```

### æ¶ˆè´¹è€…æŸ¥è¯¢

```http
GET    /api/trace/query/{code}          # æº¯æºæŸ¥è¯¢
GET    /api/trace/query/simple/{code}   # ç®€åŒ–æŸ¥è¯¢
POST   /api/trace/query/batch           # æ‰¹é‡æŸ¥è¯¢
GET    /api/trace/query/statistics      # æŸ¥è¯¢ç»Ÿè®¡
```

## ğŸ§ª æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

- **TraceRecordServiceTest** - æº¯æºè®°å½•æœåŠ¡æµ‹è¯•
- **TraceCodeServiceTest** - æº¯æºç ç”ŸæˆæœåŠ¡æµ‹è¯•
- **TBaasBlockchainServiceTest** - åŒºå—é“¾æœåŠ¡æµ‹è¯•

### é›†æˆæµ‹è¯•

- **TraceIntegrationTest** - å®Œæ•´æµç¨‹é›†æˆæµ‹è¯•
- **TraceRecordControllerTest** - æ§åˆ¶å™¨æ¥å£æµ‹è¯•

### æµ‹è¯•åœºæ™¯è¦†ç›–

```java
âœ… æº¯æºç ç”Ÿæˆå’ŒéªŒè¯
âœ… æº¯æºè®°å½•CRUDæ“ä½œ
âœ… åŒºå—é“¾ä¸Šé“¾å’ŒæŸ¥è¯¢
âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯
âœ… å¼‚å¸¸å¤„ç†å’Œé™çº§
âœ… å¹¶å‘å®‰å…¨æ€§æµ‹è¯•
âœ… åˆ†å¸ƒå¼é”æœºåˆ¶
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### åˆ†å¸ƒå¼é”ä¿æŠ¤

```java
// æº¯æºç ç”Ÿæˆé”
RLock lock = redissonClient.getLock("trace:code:generate:" + regionCode);

// æº¯æºè®°å½•åˆ›å»ºé”
RLock lock = redissonClient.getLock("trace:create:" + traceCode);
```

### æ•°æ®å®Œæ•´æ€§éªŒè¯

```java
// è®¡ç®—æœ¬åœ°æ•°æ®å“ˆå¸Œ
String localHash = calculateDataHash(traceRecord);

// å¯¹æ¯”é“¾ä¸Šæ•°æ®å“ˆå¸Œ
boolean verified = localHash.equals(chainData.getDataHash());
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å¼‚æ­¥ä¸Šé“¾å¤„ç†

```java
// 1. å…ˆä¿å­˜åˆ°æ•°æ®åº“
Long recordId = saveToDatabase(traceRecord);

// 2. å¼‚æ­¥ä¸Šé“¾
CompletableFuture.supplyAsync(() -> {
    return blockchainService.uploadTraceRecord(traceRecord);
}).thenAccept(txHash -> {
    updateBlockchainStatus(recordId, txHash, 2);
});
```

### æ‰¹é‡ä¸Šé“¾æ”¯æŒ

```java
// æ‰¹é‡å¤„ç†æœªä¸Šé“¾è®°å½•
public int batchUploadToBlockchain(Integer limit) {
    List<TraceRecord> pendingRecords = getPendingRecords(limit);
    return processRecords(pendingRecords);
}
```

## ğŸ”§ éƒ¨ç½²è¯´æ˜

### ç¯å¢ƒè¦æ±‚

- **JDK**: 21+
- **Spring Boot**: 3.3.5
- **MySQL**: 8.0+
- **Redis**: 6.0+
- **è…¾è®¯äº‘TBaas**: é•¿å®‰é“¾ä½“éªŒç½‘ç»œ

### é…ç½®æ­¥éª¤

1. **æ•°æ®åº“åˆå§‹åŒ–**
   ```sql
   -- æ‰§è¡Œ trace_init.sql è„šæœ¬
   source /path/to/trace_init.sql
   ```

2. **TBaasé…ç½®**
   ```bash
   # è®¾ç½®ç¯å¢ƒå˜é‡
   export TENCENTCLOUD_SECRET_ID=your_secret_id
   export TENCENTCLOUD_SECRET_KEY=your_secret_key
   ```

3. **åº”ç”¨å¯åŠ¨**
   ```bash
   mvn spring-boot:run -Dspring.profiles.active=dev
   ```

## ğŸ“š ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´æº¯æºæµç¨‹

```java
// 1. ç”Ÿæˆæº¯æºç 
String traceCode = traceCodeService.generateTraceCode("BJ");

// 2. åˆ›å»ºæº¯æºè®°å½•
TraceRecord record = new TraceRecord();
record.setTraceCode(traceCode);
record.setRecordStage("ç§æ¤");
record.setContentSummary("å®Œæˆç§å­æ’­ç§");
Long recordId = traceRecordService.createTraceRecord(record);

// 3. æŸ¥è¯¢æº¯æºé“¾
List<TraceRecord> chain = traceRecordService.getTraceChain(traceCode);

// 4. éªŒè¯æ•°æ®å®Œæ•´æ€§
boolean verified = traceRecordService.verifyTraceIntegrity(traceCode);

// 5. è·å–åŒºå—é“¾è¯æ˜
BlockchainProof proof = traceRecordService.getTraceProof(traceCode);
```

### æ¶ˆè´¹è€…æŸ¥è¯¢

```javascript
// å‰ç«¯æŸ¥è¯¢æº¯æºä¿¡æ¯
const response = await fetch(`/api/trace/query/${traceCode}`);
const result = await response.json();

if (result.code === 200) {
    console.log('æº¯æºè®°å½•:', result.data.traceRecords);
    console.log('åŒºå—é“¾éªŒè¯:', result.data.verified);
}
```

## ğŸ¯ æ¯•ä¸šè®¾è®¡äº®ç‚¹

### æŠ€æœ¯åˆ›æ–°

1. **åŒºå—é“¾+æº¯æº**ï¼šçœŸå®çš„åŒºå—é“¾å­˜è¯ï¼Œä¸æ˜¯ç®€å•æ¨¡æ‹Ÿ
2. **åˆ†å¸ƒå¼æ¶æ„**ï¼šä½¿ç”¨Redisåˆ†å¸ƒå¼é”ï¼Œæ”¯æŒé«˜å¹¶å‘
3. **å¼‚æ­¥å¤„ç†**ï¼šä¸šåŠ¡æ€§èƒ½ä¸åŒºå—é“¾æ€§èƒ½è§£è€¦
4. **å®Œæ•´æµ‹è¯•**ï¼š90%+ ä»£ç è¦†ç›–ç‡ï¼ŒåŒ…å«å„ç§å¼‚å¸¸åœºæ™¯

### ä¸šåŠ¡ä»·å€¼

1. **æ•°æ®å¯ä¿¡**ï¼šåŒºå—é“¾å­˜è¯ç¡®ä¿æ•°æ®ä¸å¯ç¯¡æ”¹
2. **å…¨ç¨‹è¿½æº¯**ï¼šä»ç”Ÿäº§åˆ°é”€å”®çš„å®Œæ•´é“¾æ¡
3. **æ¶ˆè´¹è€…ä¿¡ä»»**ï¼šæä¾›å¯éªŒè¯çš„æº¯æºè¯æ˜
4. **ç›‘ç®¡æ”¯æŒ**ï¼šæ»¡è¶³å†œäº§å“è´¨é‡å®‰å…¨è¦æ±‚

### æ‰©å±•æ€§

1. **å¤šé“¾æ”¯æŒ**ï¼šå¯æ‰©å±•åˆ°å…¶ä»–åŒºå—é“¾ç½‘ç»œ
2. **å¤šåœºæ™¯é€‚ç”¨**ï¼šä¸ä»…é™äºå†œäº§å“ï¼Œå¯ç”¨äºå…¶ä»–æº¯æºåœºæ™¯
3. **APIæ ‡å‡†åŒ–**ï¼šRESTful APIè®¾è®¡ï¼Œæ˜“äºç¬¬ä¸‰æ–¹é›†æˆ

## ğŸ”® æœªæ¥è§„åˆ’

- [ ] æ”¯æŒæ›´å¤šåŒºå—é“¾ç½‘ç»œï¼ˆä»¥å¤ªåŠã€Fabricç­‰ï¼‰
- [ ] é›†æˆIoTè®¾å¤‡æ•°æ®è‡ªåŠ¨é‡‡é›†
- [ ] æ·»åŠ AIè´¨é‡é¢„æµ‹å’Œé£é™©é¢„è­¦
- [ ] æ”¯æŒNFTè¯ä¹¦ç”Ÿæˆ
- [ ] ç§»åŠ¨ç«¯APPå¼€å‘
- [ ] å›½é™…åŒ–å¤šè¯­è¨€æ”¯æŒ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [è…¾è®¯äº‘TBaasæ–‡æ¡£](https://cloud.tencent.com/document/product/663)
- [Spring Bootå®˜æ–¹æ–‡æ¡£](https://spring.io/projects/spring-boot)
- [é¡¹ç›®README.md](../README.md)

**å®ç°å®Œæˆæ—¶é—´**: 2025å¹´11æœˆ18æ—¥  
**å¼€å‘è€…**: LinYi  
**ç‰ˆæœ¬**: v1.0.0
