<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linyi.cropseed.trace.mapper.TraceRecordMapper">

    <!-- 根据溯源码查询所有记录 -->
    <select id="selectByTraceCode" resultType="com.linyi.cropseed.trace.entity.TraceRecord">
        SELECT * FROM trace_record 
        WHERE trace_code = #{traceCode} AND deleted_flag = 0
        ORDER BY record_time ASC, create_time ASC
    </select>

    <!-- 根据批次ID查询记录 -->
    <select id="selectByBatchId" resultType="com.linyi.cropseed.trace.entity.TraceRecord">
        SELECT * FROM trace_record 
        WHERE batch_id = #{batchId} AND deleted_flag = 0
        ORDER BY record_time ASC, create_time ASC
    </select>

    <!-- 根据记录类型统计数量 -->
    <select id="countByRecordType" resultType="java.lang.Long">
        SELECT COUNT(*) FROM trace_record 
        WHERE record_type = #{recordType} AND deleted_flag = 0
    </select>

    <!-- 更新区块链状态 -->
    <update id="updateBlockchainStatus">
        UPDATE trace_record 
        SET blockchain_tx_hash = #{txHash}, 
            blockchain_status = #{status}, 
            update_time = NOW()
        WHERE id = #{id} AND deleted_flag = 0
    </update>

</mapper>
