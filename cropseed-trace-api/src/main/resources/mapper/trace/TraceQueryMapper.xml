<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linyi.cropseed.trace.module.trace.mapper.TraceQueryMapper">

    <!-- 统计查询次数 -->
    <select id="countByTraceCodeAndTime" resultType="java.lang.Long">
        SELECT COUNT(*) FROM trace_query
        WHERE trace_code = #{traceCode} AND deleted_flag = 0
        <if test="startTime != null">
            AND query_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND query_time &lt;= #{endTime}
        </if>
    </select>

    <!-- 查询热门溯源码 -->
    <select id="selectHotTraceCodes" resultType="java.util.Map">
        SELECT trace_code, COUNT(*) as query_count
        FROM trace_query
        WHERE deleted_flag = 0 AND query_result = 1
        GROUP BY trace_code
        ORDER BY query_count DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询统计数据 -->
    <select id="selectStatistics" resultType="java.util.Map">
        SELECT
            COUNT(*) as total_queries,
            COUNT(CASE WHEN query_result = 1 THEN 1 END) as success_queries,
            COUNT(CASE WHEN query_result = 2 THEN 1 END) as not_found_queries,
            COUNT(CASE WHEN query_result = 3 THEN 1 END) as expired_queries,
            COUNT(CASE WHEN query_result = 4 THEN 1 END) as error_queries,
            COUNT(DISTINCT trace_code) as unique_trace_codes,
            AVG(response_time) as avg_response_time,
            COUNT(CASE WHEN query_channel = 1 THEN 1 END) as scan_queries,
            COUNT(CASE WHEN query_channel = 2 THEN 1 END) as input_queries,
            COUNT(CASE WHEN query_channel = 3 THEN 1 END) as web_queries,
            COUNT(CASE WHEN query_channel = 4 THEN 1 END) as app_queries
        FROM trace_query
        WHERE deleted_flag = 0
        <if test="startTime != null">
            AND query_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND query_time &lt;= #{endTime}
        </if>
    </select>

</mapper>
